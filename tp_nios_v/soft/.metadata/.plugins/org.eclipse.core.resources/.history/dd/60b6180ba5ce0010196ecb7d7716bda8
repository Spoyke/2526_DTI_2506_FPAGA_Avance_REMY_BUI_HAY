#include <stdio.h>
#include <unistd.h> // for usleep

#include "system.h"
#include "altera_avalon_pio_regs.h"
#include "altera_avalon_i2c.h"

int main (void)
{
	/*
	printf("Hello, world!\n");

	unsigned int chenillard = 1;

	while(1) {
		for (int i = 0; i < 10; i++) {
			IOWR_ALTERA_AVALON_PIO_DATA(PIO_0_BASE, chenillard);
			chenillard = chenillard << 1;

			printf("%d\n", chenillard);
			usleep(100000);
		}

		chenillard = 1;
	}

	return 0;*/


	printf("Hello world !\n");
	printf("Test I2C\n");
	ALT_AVALON_I2C_DEV_t *i2c_dev;  //pointer to instance structure
	uint8_t txbuffer[6] = {0};
	uint8_t rxbuffer[6] = {0};

	//get a pointer to the avalon i2c instance
	i2c_dev = alt_avalon_i2c_open("/dev/i2c_0");
	if (NULL==i2c_dev)
	{
	  printf("Error: Cannot find /dev/i2c_0\n");
	  return 1;
	}

	alt_avalon_i2c_master_target_set(i2c_dev, 0x53);

	while(1){
		alt_avalon_i2c_master_tx_rx(i2c_dev, txbuffer, 1, rxbuffer, 1, ALT_AVALON_I2C_NO_INTERRUPTS);
		printf("Data send\n");
		usleep(1000000);
	}

	for (int i = 0; i < 6; i++) {
		printf("%u", rxbuffer[i]);
	}

	printf("\nFin\n");
	return 0;
}
